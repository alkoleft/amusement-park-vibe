# Техническое задание: REST API для онлайн продажи билетов

## 1. Общие сведения

**Название проекта:** REST API для онлайн продажи билетов парка аттракционов  
**Версия документа:** 1.0  
**Дата создания:** 2024  
**Заказчик:** Парк аттракционов  
**Исполнитель:** Команда разработки  

## 2. Назначение и цели проекта

### 2.1 Назначение
Разработка REST API для интеграции внешнего веб-сайта с существующей системой управления парком аттракционов на базе 1С:Предприятие 8, обеспечивающего возможность онлайн бронирования и продажи билетов.

### 2.2 Цели проекта
- Обеспечить возможность онлайн продажи всех видов билетов из существующей номенклатуры
- Реализовать систему бронирования билетов с временным резервированием
- Интегрировать с существующей базой клиентов и бонусной программой
- Обеспечить синхронизацию данных в реальном времени
- Сохранить совместимость с существующими бизнес-процессами

## 3. Архитектура решения

### 3.1 Общая архитектура
```
[Внешний веб-сайт] <---> [REST API] <---> [1С:Предприятие 8]
                          HTTP/HTTPS        Внутренние вызовы
```

### 3.2 Компоненты системы
1. **REST API сервис** - новый веб-сервис в конфигурации 1С
2. **Модули интеграции** - новые общие модули для обработки API запросов
3. **Расширение документооборота** - модификация существующих документов продажи
4. **Система бронирования** - новые объекты для управления резервированием

### 3.3 Технологический стек
- **Платформа:** 1С:Предприятие 8 (существующая)
- **Протокол:** HTTP/HTTPS
- **Формат данных:** JSON
- **Архитектура:** REST API
- **Аутентификация:** API ключи / JWT токены

## 4. Функциональные требования

### 4.1 Управление номенклатурой

#### 4.1.1 Получение списка доступной номенклатуры
**Метод:** `GET /api/v1/products`

**Параметры запроса:**
- `category` (optional) - фильтр по виду номенклатуры
- `attraction_type` (optional) - фильтр по виду аттракциона
- `active_only` (optional, default: true) - только активные позиции

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "code": "string",
      "name": "string",
      "description": "string",
      "product_type": "enum", // single_visit, subscription, group_ticket
      "attraction_type": "string",
      "visits_count": "number",
      "price": "number",
      "currency": "string",
      "active": "boolean",
      "images": ["string"]
    }
  ]
}
```

#### 4.1.2 Получение информации о конкретном продукте
**Метод:** `GET /api/v1/products/{product_id}`

**Ответ:** Детальная информация о продукте с дополнительными полями.

### 4.2 Управление клиентами

#### 4.2.1 Поиск клиента
**Метод:** `GET /api/v1/customers/search`

**Параметры запроса:**
- `phone` - номер телефона
- `email` - адрес электронной почты

**Ответ:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "code": "string",
    "name": "string",
    "phone": "string",
    "email": "string",
    "bonus_balance": "number",
    "registered_date": "datetime"
  }
}
```

#### 4.2.2 Создание нового клиента
**Метод:** `POST /api/v1/customers`

**Тело запроса:**
```json
{
  "name": "string",
  "phone": "string",
  "email": "string",
  "additional_info": {
    "address": "string",
    "birth_date": "date"
  }
}
```

#### 4.2.3 Получение баланса бонусов
**Метод:** `GET /api/v1/customers/{customer_id}/bonus`

### 4.3 Система бронирования

#### 4.3.1 Создание брони
**Метод:** `POST /api/v1/reservations`

**Тело запроса:**
```json
{
  "customer_id": "uuid",
  "items": [
    {
      "product_id": "uuid",
      "quantity": "number",
      "visit_date": "date", // если применимо
      "visit_time": "time"  // если применимо
    }
  ],
  "bonus_to_use": "number", // количество бонусов для списания
  "reservation_duration": "number" // минуты (по умолчанию 15)
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "reservation_id": "uuid",
    "expires_at": "datetime",
    "total_amount": "number",
    "bonus_discount": "number",
    "final_amount": "number",
    "items": [
      {
        "product_id": "uuid",
        "product_name": "string",
        "quantity": "number",
        "price": "number",
        "total": "number"
      }
    ]
  }
}
```

#### 4.3.2 Проверка статуса брони
**Метод:** `GET /api/v1/reservations/{reservation_id}`

#### 4.3.3 Отмена брони
**Метод:** `DELETE /api/v1/reservations/{reservation_id}`

### 4.4 Обработка платежей

#### 4.4.1 Подтверждение оплаты
**Метод:** `POST /api/v1/reservations/{reservation_id}/payment`

**Тело запроса:**
```json
{
  "payment_method": "string", // card, wallet, etc.
  "payment_id": "string",     // ID транзакции из платежной системы
  "amount": "number",
  "currency": "string",
  "payment_details": {
    "gateway": "string",
    "transaction_id": "string",
    "payment_date": "datetime"
  }
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "ticket_id": "uuid",
    "ticket_number": "string",
    "qr_code": "string", // base64 или URL
    "purchase_date": "datetime",
    "total_paid": "number",
    "bonus_earned": "number",
    "bonus_used": "number"
  }
}
```

### 4.5 Управление билетами

#### 4.5.1 Получение информации о билете
**Метод:** `GET /api/v1/tickets/{ticket_id}`

#### 4.5.2 Получение списка билетов клиента
**Метод:** `GET /api/v1/customers/{customer_id}/tickets`

## 5. Нефункциональные требования

### 5.1 Производительность
- Время отклика API: не более 2 секунд для стандартных операций
- Время отклика для создания брони: не более 5 секунд
- Поддержка одновременных запросов: минимум 100 concurrent requests

### 5.2 Надежность
- Автоматическое освобождение истекших броней
- Обработка ошибок с информативными сообщениями
- Валидация входящих данных

### 5.3 Валидация данных
- Валидация всех входящих данных
- Проверка корректности JSON структуры
- Контроль бизнес-правил

## 6. Структура данных

### 6.1 Новые объекты метаданных

#### 6.1.1 Документ "БронированиеБилетов"
**Назначение:** Фиксация бронирования билетов через API (только количественная информация)

**Реквизиты:**
- Клиент (СправочникСсылка.Клиенты)
- СтатусБрони (Перечисление.СтатусыБронирования)
- ВремяИстечения (Дата)

**Табличная часть "Позиции":**
- Номенклатура (СправочникСсылка.Номенклатура)
- Количество (Число)
- Цена (Число) // для информации, но расчеты ведутся по актуальным ценам

#### 6.1.2 Перечисление "СтатусыБронирования"
- Активная
- Оплачена
- Отменена
- Истекла

#### 6.1.3 Регистр накопления "БронированиеПосещений"
**Назначение:** Учет забронированных, но еще не оплаченных посещений для контроля доступности

**Измерения:**
- БронированиеБилетов (ДокументСсылка.БронированиеБилетов)
- ВидАттракциона (СправочникСсылка.ВидыАттракционов)

**Ресурсы:**
- КоличествоПосещений (Число)

### 6.2 Модификация существующих объектов

#### 6.2.1 Документ "БронированиеБилетов" - движения по регистрам
**При проведении создает движения:**
- РегистрНакопления.БронированиеПосещений (Приход) - резервирует посещения
- При отмене/истечении: РегистрНакопления.БронированиеПосещений (Расход) - освобождает резерв

#### 6.2.2 Документ "ПродажаБилета" 
**Новые реквизиты:**
- БронированиеБилетов (ДокументСсылка.БронированиеБилетов) // связь с бронью при онлайн продаже

**Модификация проведения:**
- При создании из брони автоматически освобождает резерв в "БронированиеПосещений" (Расход)
- Создает движения по "АктивныеПосещения" как обычно

## 7. API Endpoints

### 7.1 Базовый URL
`https://your-domain.com/api/v1/`

### 7.2 Аутентификация
Аутентификация обеспечивается платформой 1С и находится за границами данного решения. Предполагается, что внешний веб-сайт уже прошел аутентификацию на уровне веб-сервера или приложения.

### 7.3 Полный список endpoints

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/products` | Список номенклатуры |
| GET | `/products/{id}` | Детали продукта |
| GET | `/customers/search` | Поиск клиента |
| POST | `/customers` | Создание клиента |
| GET | `/customers/{id}/bonus` | Баланс бонусов |
| POST | `/reservations` | Создание брони |
| GET | `/reservations/{id}` | Статус брони |
| DELETE | `/reservations/{id}` | Отмена брони |
| POST | `/reservations/{id}/payment` | Подтверждение оплаты |
| GET | `/tickets/{id}` | Информация о билете |
| GET | `/customers/{id}/tickets` | Билеты клиента |

### 7.4 Коды ошибок

| Код | Описание | Действие |
|-----|----------|----------|
| 200 | Успешно | - |
| 400 | Неверный запрос | Проверить параметры |
| 401 | Не авторизован | Проверить API ключ |
| 404 | Не найдено | Проверить ID ресурса |
| 409 | Конфликт | Бронь истекла/недоступна |
| 422 | Ошибка валидации | Исправить данные |
| 500 | Внутренняя ошибка | Обратиться к администратору |

## 8. Бизнес-логика

### 8.1 Процесс бронирования
1. Клиент выбирает товары на сайте
2. Сайт отправляет запрос на создание брони
3. Система проверяет доступность товаров (контроль остатков - см. п. 8.4)
4. Создается документ "БронированиеБилетов" со статусом "Активная"
5. Резервируются позиции в регистре "БронированиеПосещений" (приход)
6. Возвращается ID брони и время истечения

### 8.2 Процесс оплаты
1. Сайт обрабатывает платеж через платежную систему
2. При успешной оплате отправляется запрос подтверждения
3. Меняется статус брони на "Оплачена"
4. Создается документ "ПродажаБилета"
5. Начисляются бонусы клиенту
6. Генерируется QR-код билета

### 8.3 Управление истекшими бронями
- Регламентное задание проверяет истекшие брони каждые 5 минут
- Освобождает зарезервированные позиции в регистре "БронированиеПосещений" (расход)
- Меняет статус на "Истекла"

### 8.4 Контроль остатков билетов
**Существующий механизм:** В системе уже реализован контроль остатков через регистр накопления "АктивныеПосещения", который:
- Ведет учет остатков посещений по видам аттракционов для каждого проданного билета
- При посещении аттракциона списывает посещения (документ "ПосещениеАттракциона")
- Блокирует посещение при отсутствии остатков

**Модификация для онлайн продаж:**
- Новый регистр "БронированиеПосещений" будет учитывать забронированные посещения
- При проверке доступности товара для брони система будет учитывать:
  - Неограниченные товары (без лимитов) - всегда доступны
  - Ограниченные товары - проверка по остаткам с учетом активных броней
- Формула доступности: `Доступно = ОстатокНаСкладе - АктивныеБрони`
- Для номенклатуры типа "абонемент" контроль ведется по количеству посещений конкретного вида аттракциона

### 8.5 Бонусная программа
- При создании брони рассчитывается возможная скидка
- Бонусы списываются только после подтверждения оплаты
- Новые бонусы начисляются согласно существующей шкале

## 9. Интеграция с существующей системой

### 9.1 Использование существующих объектов
- Справочник.Клиенты - для управления клиентской базой
- Справочник.Номенклатура - источник данных о продуктах
- РегистрСведений.ЦеныНоменклатуры - актуальные цены
- РегистрНакопления.БонусныеБаллыКлиентов - бонусная программа
- Документ.ПродажаБилета - финальная фиксация продажи

### 9.2 Новые общие модули
- **APIОнлайнПродаж** - основная логика API
- **УправлениеБронированием** - работа с бронями  
- **КонтрольОстатковБилетов** - проверка доступности товаров с учетом броней
- **ВалидацияДанныхAPI** - проверка входящих данных

## 10. Этапы разработки

### 10.1 Этап 1: Базовая инфраструктура (2 недели)
- Создание веб-сервиса и базовых endpoints
- Реализация аутентификации
- Создание новых объектов метаданных
- Базовое логирование

### 10.2 Этап 2: Управление номенклатурой и клиентами (1 неделя)
- API для получения списка продуктов
- API для работы с клиентами
- Интеграция с бонусной программой

### 10.3 Этап 3: Система бронирования (2 недели)
- Создание и управление бронями
- Резервирование позиций
- Автоматическое освобождение истекших броней

### 10.4 Этап 4: Обработка платежей (1 неделя)
- API подтверждения оплаты
- Создание документов продажи
- Генерация QR-кодов

### 10.5 Этап 5: Тестирование (1 неделя)
- Комплексное тестирование
- Оптимизация производительности
- Документация API

## 11. Тестирование

### 11.1 Виды тестирования
- Модульное тестирование API методов
- Интеграционное тестирование с существующей системой
- Нагрузочное тестирование

### 11.2 Тестовые сценарии
1. Создание и оплата простой брони
2. Работа с бонусной программой
3. Обработка истекших броней
4. Одновременные запросы на один товар
5. Некорректные данные и ошибки

## 12. Развертывание и сопровождение

### 12.1 Требования к серверу
- Существующий сервер с 1С:Предприятие 8
- Веб-сервер (IIS/Apache) для публикации API
- SSL сертификат для HTTPS

### 12.2 Поддержка
- Документирование изменений
- Регулярные проверки работоспособности
- Обновление документации API

### 12.3 Резервное копирование
- Регулярное резервное копирование базы данных
- Версионирование конфигурации
- Документирование изменений

## 13. Документация

### 13.1 Техническая документация
- API Reference с примерами запросов
- Схема базы данных
- Руководство по развертыванию
- Руководство администратора

### 13.2 Пользовательская документация
- Руководство для разработчиков внешних систем
- Примеры интеграции
- FAQ по использованию API

## 14. Заключение

Данное техническое задание описывает создание REST API для интеграции внешнего веб-сайта с существующей системой управления парком аттракционов. Решение обеспечит:

- Полную интеграцию с существующей бизнес-логикой
- Надежную систему бронирования с временным резервированием
- Работу с бонусной программой
- Синхронизацию данных в реальном времени
- Масштабируемость и производительность

Реализация займет приблизительно 7 недель и потребует координации с командой разработки внешнего веб-сайта для обеспечения корректной интеграции.
