# ПЛАН РЕАЛИЗАЦИИ REST API ДЛЯ ОНЛАЙН ПРОДАЖИ БИЛЕТОВ

## 1. ОБЩАЯ ИНФОРМАЦИЯ О ПРОЕКТЕ

**Название проекта:** REST API для онлайн продажи билетов парка аттракционов  
**Версия плана:** 1.0  
**Дата создания:** 2024  
**Срок реализации:** 7 недель (49 дней)  
**Команда разработки:** 2-3 разработчика 1С  

### 1.1 Цели проекта
- Реализация REST API для интеграции с внешним веб-сайтом
- Создание системы онлайн бронирования билетов
- Интеграция с существующей бонусной программой
- Обеспечение синхронизации данных в реальном времени
- Сохранение совместимости с текущими бизнес-процессами

### 1.2 Ключевые принципы реализации
- Минимальные изменения в существующих объектах
- Максимальное переиспользование текущей логики
- Четкое разделение ответственности между модулями
- Производительность и масштабируемость
- Надежность и отказоустойчивость

## 2. АРХИТЕКТУРНЫЙ ОБЗОР

### 2.1 Новые компоненты системы
```
[Веб-сайт] → [REST API] → [Система бронирования] → [Существующие модули]
                ↓
           [Валидация]
                ↓
           [Бизнес-логика]
                ↓
           [База данных 1С]
```

### 2.2 Интеграция с существующими модулями
- Справочник.Клиенты - управление клиентами
- Справочник.Номенклатура - каталог услуг
- Документ.ПродажаБилета - финальная продажа
- РегистрНакопления.БонусныеБаллыКлиентов - бонусная программа
- РегистрНакопления.АктивныеПосещения - контроль остатков

## 3. ДЕТАЛЬНЫЙ ПЛАН ЭТАПОВ

### ЭТАП 1: БАЗОВАЯ ИНФРАСТРУКТУРА (Недели 1-2)

#### 3.1.1 Создание HTTP-сервиса (Дни 1-3)
**Задача:** Создание базовой инфраструктуры REST API

**Создаваемые объекты:**
- **HTTPService "api"**
  - URL шаблон: `/api/v1/`
  - Методы для каждого endpoint (см. детальную структуру ниже)

**Общие модули:**
- **ОнлайнПродажиСервер** (серверный) - основной модуль для REST API
  - Функции:
    - `СформироватьОтветУспех(Данные)`
    - `СформироватьОтветОшибка(КодОшибки, ТекстОшибки, ДополнительныеДанные = Неопределено)`
    - `ПолучитьВерсиюАПИ()`
    - `ЗаписатьВЖурналАПИ(ТипСобытия, Описание, ДанныеЗапроса = Неопределено)`
    - `ВалидироватьДжейСОН(СтрокаДжейСОН)`
    - `ПроверитьОбязательныеПоля(Данные, МассивПолей)`
    - `ВалидироватьТелефон(НомерТелефона)`
    - `ВалидироватьЭлектроннуюПочту(АдресЭлектроннойПочты)`

## 3.1.1.1 ДЕТАЛЬНАЯ СТРУКТУРА HTTP-СЕРВИСА "api"

### Конфигурация HTTP-сервиса
- **Имя:** api
- **Корневой URL:** `/api/v1/`
- **Корневой модуль:** ОнлайнПродажиСервер (только для маршрутизации)

### Структура методов HTTP-сервиса

#### Группа: Управление номенклатурой
**URL шаблон:** `/products`

1. **ПолучитьСписокНоменклатуры**
   - **HTTP метод:** GET
   - **URL шаблон:** `/products`
   - **Параметры запроса:** 
     - `category` (необязательный) - вид номенклатуры
     - `attraction_type` (необязательный) - вид аттракциона
     - `active_only` (необязательный, по умолчанию true)
   - **Возвращает:** JSON массив номенклатуры

2. **ПолучитьДанныеНоменклатуры**
   - **HTTP метод:** GET  
   - **URL шаблон:** `/products/{id}`
   - **Параметры URL:** `id` - идентификатор номенклатуры
   - **Возвращает:** JSON объект с детальными данными

#### Группа: Управление клиентами  
**URL шаблон:** `/customers`

3. **НайтиКлиента**
   - **HTTP метод:** GET
   - **URL шаблон:** `/customers/search`
   - **Параметры запроса:**
     - `phone` (необязательный) - номер телефона
     - `email` (необязательный) - адрес электронной почты
   - **Возвращает:** JSON объект с данными клиента или null

4. **СоздатьКлиента**
   - **HTTP метод:** POST
   - **URL шаблон:** `/customers`
   - **Тело запроса:** JSON с данными клиента
   - **Возвращает:** JSON объект созданного клиента

5. **ПолучитьБалансБонусов**
   - **HTTP метод:** GET
   - **URL шаблон:** `/customers/{id}/bonus`
   - **Параметры URL:** `id` - идентификатор клиента
   - **Возвращает:** JSON объект с балансом бонусов

#### Группа: Система бронирования
**URL шаблон:** `/reservations`

6. **СоздатьБронирование**
   - **HTTP метод:** POST
   - **URL шаблон:** `/reservations`
   - **Тело запроса:** JSON с данными брони
   - **Возвращает:** JSON объект созданной брони

7. **ПолучитьСтатусБронирования**
   - **HTTP метод:** GET
   - **URL шаблон:** `/reservations/{id}`
   - **Параметры URL:** `id` - идентификатор брони
   - **Возвращает:** JSON объект со статусом брони

8. **ОтменитьБронирование**
   - **HTTP метод:** DELETE
   - **URL шаблон:** `/reservations/{id}`
   - **Параметры URL:** `id` - идентификатор брони
   - **Возвращает:** JSON подтверждение отмены

#### Группа: Обработка платежей
**URL шаблон:** `/reservations/{id}/payment`

9. **ПодтвердитьОплатуБронирования**
   - **HTTP метод:** POST
   - **URL шаблон:** `/reservations/{id}/payment`
   - **Параметры URL:** `id` - идентификатор брони
   - **Тело запроса:** JSON с данными платежа
   - **Возвращает:** JSON объект с данными билета

#### Группа: Управление билетами
**URL шаблон:** `/tickets`

10. **ПолучитьИнформациюОБилете**
    - **HTTP метод:** GET
    - **URL шаблон:** `/tickets/{id}`
    - **Параметры URL:** `id` - идентификатор билета
    - **Возвращает:** JSON объект с данными билета

11. **ПолучитьБилетыКлиента**
    - **HTTP метод:** GET
    - **URL шаблон:** `/customers/{id}/tickets`
    - **Параметры URL:** `id` - идентификатор клиента
    - **Параметры запроса:**
      - `limit` (необязательный) - количество билетов
      - `offset` (необязательный) - смещение для пагинации
    - **Возвращает:** JSON массив билетов клиента

### Пример реализации метода HTTP-сервиса и обработчика

#### Метод HTTP-сервиса (только маршрутизация):
```bsl
Функция ПолучитьСписокНоменклатуры(Запрос)
    // Простая маршрутизация - передача управления в бизнес-модуль
    Возврат ОнлайнПродажиСервер.ОбработатьПолучениеСпискаНоменклатуры(Запрос);
КонецФункции
```

#### Обработчик в модуле ОнлайнПродажиСервер:
```bsl
Функция ОбработатьПолучениеСпискаНоменклатуры(Запрос) Экспорт
    
    НачалоВремени = ТекущаяДатаМиллисекунды();
    
    Попытка
        // 1. Извлечение параметров из запроса
        ПараметрыОтбора = Новый Структура();
        ПараметрыОтбора.Вставить("ВидАттракциона", Запрос.ПараметрыЗапроса.Получить("attraction_type"));
        ПараметрыОтбора.Вставить("ТолькоАктивные", Булево(Запрос.ПараметрыЗапроса.Получить("active_only")));
        
        // 2. Валидация параметров (если необходимо)
        // ... код валидации ...
        
        // 3. Вызов бизнес-логики
        СписокНоменклатуры = УправлениеДаннымиСервер.ПолучитьСписокНоменклатурыДляПродажи(ПараметрыОтбора);
        
        // 4. Формирование успешного ответа
        Результат = СформироватьОтветУспех(СписокНоменклатуры);
        
    Исключение
        // 5. Обработка ошибок
        Результат = СформироватьОтветОшибка(500, "Внутренняя ошибка сервера", ОписаниеОшибки());
    КонецПопытки;
    
    // 6. Журналирование
    ВремяВыполнения = ТекущаяДатаМиллисекунды() - НачалоВремени;
    ЗаписатьВЖурналАПИ("GET /products", "Получение списка номенклатуры", ВремяВыполнения);
    
    Возврат Результат;
    
КонецФункции
```

**Тестовые кейсы:**
1. Проверка доступности каждого API endpoint
2. Валидация корректного JSON для POST методов
3. Обработка некорректного JSON
4. Возврат стандартного формата ответа
5. Проверка HTTP статус кодов
6. Модульное тестирование обработчиков (без HTTP-сервиса)
7. Тестирование маршрутизации HTTP-сервиса

#### 3.1.2 Создание новых объектов метаданных (Дни 4-6)

**Документ "БронированиеБилетов":**
```
Реквизиты:
- Клиент: СправочникСсылка.Клиенты
- СтатусБрони: ПеречислениеСсылка.СтатусыБронирования
- ВремяИстечения: Дата
- СуммаДокумента: Число(15,2)
- СуммаБонусов: Число(15,2)
- КлючАПИ: Строка(50) // для идентификации внешних запросов

Табличная часть "Позиции":
- Номенклатура: СправочникСсылка.Номенклатура
- Количество: Число(10,3)
- Цена: Число(15,2)
- Сумма: Число(15,2)
- ДатаПосещения: Дата
- ВремяПосещения: Дата

Обработчики событий объекта:
- ПриЗаписи(Отказ) - контроль статуса и времени истечения
- ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения) - валидация данных
- ОбработкаПроведения(Отказ, РежимПроведения) - создание движений по регистру БронированиеПосещений
- ОбработкаУдаленияПроведения(Отказ) - освобождение резерва в регистре
- ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты) - проверка обязательных полей

Примечание: Проведение и отмена проведения выполняются через метод Записать() с соответствующими параметрами:
- ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение) - вызывает ОбработкаПроведения()
- ДокументОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения) - вызывает ОбработкаУдаленияПроведения()

Пример использования в коде:
```bsl
// Создание и проведение брони
БронированиеОбъект = Документы.БронированиеБилетов.СоздатьДокумент();
// ... заполнение реквизитов ...
БронированиеОбъект.Записать(РежимЗаписиДокумента.Проведение); // Резервирование позиций

// Отмена брони при истечении времени
БронированиеОбъект = БронированиеСсылка.ПолучитьОбъект();
БронированиеОбъект.СтатусБрони = Перечисления.СтатусыБронирования.Истекла;
БронированиеОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения); // Освобождение резерва
```

**Перечисление "СтатусыБронирования":**
- Активная
- Оплачена  
- Отменена
- Истекла

**Регистр накопления "БронированиеПосещений":**
```
Измерения:
- БронированиеБилетов: ДокументСсылка.БронированиеБилетов
- ВидАттракциона: СправочникСсылка.ВидыАттракционов
- Период: Дата

Ресурсы:
- КоличествоПосещений: Число(10,3)

Движения:
- При проведении брони: Приход (резерв)
- При отмене/истечении: Расход (освобождение)
```

**Тестовые кейсы:**
1. Создание документа БронированиеБилетов
2. Запись документа с проведением (РежимЗаписиДокумента.Проведение) и с отменой проведения (РежимЗаписиДокумента.ОтменаПроведения)
3. Проверка движений по регистру
4. Смена статусов брони
5. Контроль времени истечения

#### 3.1.3 Базовая валидация и логирование (Дни 7-8)

**Регистр сведений "ЖурналОнлайнПродаж":**
```
Измерения:
- Дата: Дата
- Пользователь: СправочникСсылка.Пользователи
- ТипОперации: Строка(50)
- УникальныйИдентификатор: Строка(36)

Ресурсы:
- Описание: Строка(500)
- ДанныеЗапроса: ХранилищеЗначения
- ВремяВыполнения: Число(10,3)
- КодОтвета: Число(3,0)
```

*Примечание: Функции журналирования добавлены в основной модуль ОнлайнПродажиСервер*

**Тестовые кейсы:**
1. Логирование успешных запросов
2. Логирование ошибок
3. Контроль производительности запросов

### ЭТАП 2: УПРАВЛЕНИЕ НОМЕНКЛАТУРОЙ И КЛИЕНТАМИ (Неделя 3)

#### 3.2.1 API управления номенклатурой (Дни 9-11)

**Общий модуль "УправлениеДаннымиСервер"** (серверный) - работа с номенклатурой и клиентами:
```
Функции номенклатуры:
- ПолучитьСписокНоменклатурыДляПродажи(ПараметрыОтбора)
  Параметры: Структура с полями ВидАттракциона, ТолькоАктивные
  Возврат: Массив структур с данными номенклатуры

- ПолучитьДанныеНоменклатуры(СсылкаНоменклатуры)
  Возврат: Структура с детальными данными

- ПолучитьАктуальныеЦеныНоменклатуры(МассивНоменклатуры, ДатаАктуальности = Неопределено)
  Возврат: Соответствие СсылкаНоменклатуры -> ЦенаНоменклатуры

Функции клиентов:
- НайтиКлиентаПоКонтактам(НомерТелефона = "", АдресЭлектроннойПочты = "")
  Возврат: СправочникСсылка.Клиенты или Неопределено

- СоздатьНовогоКлиента(ДанныеКлиента)
  Параметры: Структура с полями Наименование, Телефон, ЭлектроннаяПочта
  Возврат: СправочникСсылка.Клиенты

- ПолучитьБалансБонусовКлиента(СсылкаКлиента)
  Возврат: Число - текущий баланс бонусных баллов

- ПроверитьВозможностьСписанияБонусов(СсылкаКлиента, СуммаКСписанию)
  Возврат: Булево - можно ли списать указанную сумму бонусов
```

**Endpoints реализации:**
- `GET /api/v1/products`
- `GET /api/v1/products/{id}`

**Структура ответа для номенклатуры:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "code": "string", 
      "name": "string",
      "description": "string",
      "product_type": "single_visit|subscription|group_ticket",
      "attraction_type": "string",
      "visits_count": "number",
      "price": "number",
      "currency": "RUB",
      "active": "boolean",
      "images": ["string"],
      "restrictions": {
        "min_age": "number",
        "max_age": "number",
        "max_capacity": "number"
      }
    }
  ]
}
```

**Тестовые кейсы:**
1. Получение списка всей номенклатуры
2. Фильтрация по виду аттракциона
3. Получение только активной номенклатуры
4. Получение детальной информации о продукте
5. Обработка несуществующего ID продукта

#### 3.2.2 Дополнительные функции управления клиентами (Дни 12-14)

*Примечание: Функции клиентов добавлены в модуль УправлениеДаннымиСервер*

**Endpoints реализации:**
- `GET /api/v1/customers/search?phone={phone}&email={email}`
- `POST /api/v1/customers`
- `GET /api/v1/customers/{id}/bonus`

**Тестовые кейсы:**
1. Поиск клиента по телефону и email
2. Создание нового клиента
3. Получение баланса бонусов
4. Обработка дублирования клиентов
5. Валидация контактных данных
6. Расчет скидки по бонусам
7. Проверка ограничений бонусной программы

### ЭТАП 3: СИСТЕМА БРОНИРОВАНИЯ (Недели 4-5)

#### 3.3.1 Создание и управление бронями (Дни 16-21)

**Общий модуль "УправлениеБронированиемСервер"** (серверный) - бронирование, контроль остатков, платежи:
```
Функции бронирования:
- СоздатьБронирование(ДанныеБронирования)
  Параметры: Структура с полями:
    - СсылкаКлиента: СправочникСсылка.Клиенты
    - МассивПозиций: Массив структур с номенклатурой и количеством
    - СуммаБонусовКСписанию: Число
    - ВремяЖизниВМинутах: Число (по умолчанию 15)
  Возврат: Структура с данными созданного бронирования

- ПолучитьСтатусБронирования(СсылкаБронирования)
  Возврат: Структура со статусом и данными бронирования

- ОтменитьБронирование(СсылкаБронирования, ПричинаОтмены = "")
  Возврат: Булево - успешность операции отмены

Функции контроля остатков:
- ПроверитьДоступностьНоменклатуры(СсылкаНоменклатуры, КоличествоКПроверке)
  Возврат: Структура с результатом проверки

- ЗарезервироватьПозиции(СсылкаБронирования, МассивПозиций)
  Создает движения по регистру БронированиеПосещений

- ОсвободитьРезерв(СсылкаБронирования)
  Освобождает зарезервированные позиции

Функции платежей:
- ПодтвердитьОплатуБронирования(СсылкаБронирования, ДанныеПлатежа)
  Возврат: Структура с данными созданного билета

- СоздатьПродажуИзБронирования(СсылкаБронирования, ДанныеПлатежа)
  Возврат: ДокументСсылка.ПродажаБилета

- ОбработатьБонусыПриОплате(СсылкаКлиента, СуммаПокупки, СуммаБонусовКСписанию)
  Списание и начисление бонусных баллов
```

**Алгоритм создания брони:**
1. Валидация входящих данных
2. Проверка существования клиента
3. Проверка доступности товаров
4. Расчет стоимости с учетом бонусов
5. Создание документа БронированиеБилетов
6. Резервирование позиций в регистре
7. Возврат данных брони с ID и временем истечения

**Endpoints реализации:**
- `POST /api/v1/reservations`
- `GET /api/v1/reservations/{id}`  
- `DELETE /api/v1/reservations/{id}`

**Тестовые кейсы:**
1. Создание простой брони на один товар
2. Создание брони на несколько товаров
3. Создание брони с использованием бонусов
4. Проверка статуса активной брони
5. Отмена брони клиентом
6. Обработка брони с недоступным товаром
7. Создание брони для несуществующего клиента

*Примечание: Функции контроля остатков включены в модуль УправлениеБронированиемСервер*

**Тестовые кейсы:**
1. Проверка остатков неограниченной номенклатуры
2. Проверка остатков ограниченной номенклатуры
3. Проверка с учетом активных броней
4. Резервирование позиций при создании брони
5. Освобождение резерва при отмене брони
6. Одновременные запросы на один товар
7. Превышение доступного количества

#### 3.3.3 Автоматическая очистка истекших броней (Дни 26-28)

**Регламентное задание "ОчисткаИстекшихБроней":**
- Расписание: каждые 5 минут
- Процедура: ОчиститьИстекшиеБрони

**Общий модуль "СлужебныеОперацииСервер"** (серверный) - автоочистка и генерация билетов:
```
Функции автоочистки:
- ВыполнитьОчисткуИстекшихБронирований()
  Алгоритм:
    1. Найти все бронирования со статусом "Активная" 
    2. Отфильтровать по ВремяИстечения < ТекущаяДата()
    3. Для каждого истекшего бронирования:
       - Изменить статус на "Истекла"
       - Записать документ с отменой проведения (освободить резерв)
       - Записать в журнал

- ПолучитьСписокИстекшихБронирований()
  Возврат: Массив ссылок на документы БронированиеБилетов

Функции генерации билетов:
- СгенерироватьКьюАрКодДляБилета(СсылкаПродажаБилета)
  Возврат: Строка в формате base64

- СформироватьДанныеБилета(СсылкаПродажаБилета)
  Возврат: Структура с данными билета для API

- ПолучитьИнформациюОБилете(НомерБилета)
  Возврат: Структура с данными билета

- ПолучитьСписокБилетовКлиента(СсылкаКлиента, КоличествоЗаписей = 50, СмещениеЗаписей = 0)
  Возврат: Массив структур с билетами клиента
```

**Обработка "МониторингБроней":**
- Отчет по активным броням
- Статистика истекших броней  
- Контроль времени жизни броней

**Тестовые кейсы:**
1. Автоматическое истечение брони по времени
2. Освобождение зарезервированных позиций
3. Логирование истекших броней
4. Производительность при большом количестве броней
5. Корректность работы регламентного задания

### ЭТАП 4: ОБРАБОТКА ПЛАТЕЖЕЙ И СОЗДАНИЕ БИЛЕТОВ (Неделя 6)

*Примечание: Функции обработки платежей включены в модуль УправлениеБронированиемСервер, функции генерации билетов - в модуль СлужебныеОперацииСервер*

**Модификация документа "ПродажаБилета":**
- Новый реквизит: БронированиеБилетов (ДокументСсылка.БронированиеБилетов)
- Модификация обработчика ОбработкаПроведения(): при создании из брони автоматически записывать бронирование с отменой проведения для освобождения резерва

**Endpoint реализации:**
- `POST /api/v1/reservations/{id}/payment`

**Тестовые кейсы:**
1. Успешное подтверждение оплаты активной брони
2. Попытка оплаты истекшей брони
3. Попытка оплаты уже оплаченной брони
4. Создание документа продажи из брони
5. Корректное списание и начисление бонусов
6. Генерация QR-кода билета

**Структура данных билета:**
```json
{
  "ticket_id": "uuid",
  "ticket_number": "string", 
  "qr_code": "base64_string",
  "purchase_date": "datetime",
  "customer": {
    "name": "string",
    "phone": "string"
  },
  "items": [
    {
      "product_name": "string",
      "quantity": "number",
      "visit_date": "date",
      "visit_time": "time"
    }
  ],
  "total_paid": "number",
  "bonus_earned": "number", 
  "bonus_used": "number"
}
```

**Endpoints реализации:**
- `GET /api/v1/tickets/{id}`
- `GET /api/v1/customers/{id}/tickets`

**Тестовые кейсы:**
1. Генерация QR-кода для билета
2. Получение информации о билете по ID
3. Получение списка билетов клиента
4. Корректность данных в билете
5. Уникальность QR-кодов

### ЭТАП 5: ТЕСТИРОВАНИЕ И ОПТИМИЗАЦИЯ (Неделя 7)

#### 3.5.1 Комплексное тестирование (Дни 36-42)

**Интеграционные тесты:**
1. **Полный цикл онлайн покупки:**
   - Получение номенклатуры
   - Поиск/создание клиента
   - Создание брони
   - Подтверждение оплаты
   - Получение билета

2. **Сценарии с бонусной программой:**
   - Покупка с частичной оплатой бонусами
   - Покупка с полной оплатой бонусами (в пределах лимита)
   - Начисление бонусов за покупку

3. **Обработка ошибочных ситуаций:**
   - Истечение времени брони
   - Недоступность товара
   - Некорректные данные клиента
   - Проблемы с платежом

**Нагрузочные тесты:**
1. Одновременные запросы на создание броней
2. Массовое истечение броней
3. Высокая нагрузка на API endpoints
4. Производительность регламентных заданий

**Тесты безопасности:**
1. Валидация входящих данных
2. Обработка SQL-инъекций в JSON
3. Контроль доступа к API
4. Логирование подозрительной активности

#### 3.5.2 Оптимизация производительности (Дни 43-45)

**Оптимизация запросов:**
- Индексы для регистра БронированиеПосещений
- Оптимизация запросов проверки остатков
- Кэширование часто запрашиваемых данных

**Оптимизация API:**
- Пагинация для больших списков
- Сжатие JSON ответов
- Кэширование номенклатуры

#### 3.5.3 Документация и развертывание (Дни 46-49)

**Техническая документация:**
1. API Reference с примерами
2. Схема базы данных  
3. Руководство по развертыванию
4. Инструкции по настройке

**Подготовка к развертыванию:**
1. Миграционные скрипты
2. Настройка регламентных заданий
3. Конфигурация веб-сервера
4. Тестирование на боевом окружении

## 4. ДЕТАЛЬНАЯ СПЕЦИФИКАЦИЯ ОБЪЕКТОВ

### 4.1 HTTP-сервис и общие модули

## 4. ИТОГОВАЯ СТРУКТУРА МОДУЛЕЙ

### 4.1 HTTP-сервис "api"
```
Корневой URL: /api/v1/
Корневой модуль: ОнлайнПродажиСервер

Методы HTTP-сервиса (только маршрутизация):
1. ПолучитьСписокНоменклатуры (GET /products) → ОнлайнПродажиСервер.ОбработатьПолучениеСпискаНоменклатуры()
2. ПолучитьДанныеНоменклатуры (GET /products/{id}) → ОнлайнПродажиСервер.ОбработатьПолучениеДанныхНоменклатуры()
3. НайтиКлиента (GET /customers/search) → ОнлайнПродажиСервер.ОбработатьПоискКлиента()
4. СоздатьКлиента (POST /customers) → ОнлайнПродажиСервер.ОбработатьСозданиеКлиента()
5. ПолучитьБалансБонусов (GET /customers/{id}/bonus) → ОнлайнПродажиСервер.ОбработатьПолучениеБалансаБонусов()
6. СоздатьБронирование (POST /reservations) → ОнлайнПродажиСервер.ОбработатьСозданиеБронирования()
7. ПолучитьСтатусБронирования (GET /reservations/{id}) → ОнлайнПродажиСервер.ОбработатьПолучениеСтатусаБронирования()
8. ОтменитьБронирование (DELETE /reservations/{id}) → ОнлайнПродажиСервер.ОбработатьОтменуБронирования()
9. ПодтвердитьОплатуБронирования (POST /reservations/{id}/payment) → ОнлайнПродажиСервер.ОбработатьПодтверждениеОплаты()
10. ПолучитьИнформациюОБилете (GET /tickets/{id}) → ОнлайнПродажиСервер.ОбработатьПолучениеИнформацииОБилете()
11. ПолучитьБилетыКлиента (GET /customers/{id}/tickets) → ОнлайнПродажиСервер.ОбработатьПолучениеБилетовКлиента()

Примечание: Каждый метод HTTP-сервиса выполняет только маршрутизацию запроса и вызывает 
соответствующий обработчик из модуля ОнлайнПродажиСервер для выполнения бизнес-логики.
```

### 4.2 Общие модули (всего 4 модуля)

#### 4.2.1 ОнлайнПродажиСервер (серверный) - основной модуль API и обработчики HTTP-запросов
```
Служебные функции:
- СформироватьОтветУспех(Данные) Экспорт
- СформироватьОтветОшибка(КодОшибки, ТекстОшибки, ДополнительныеДанные = Неопределено) Экспорт
- ПолучитьВерсиюАПИ() Экспорт
- ЗаписатьВЖурналАПИ(ТипСобытия, Описание, ДанныеЗапроса = Неопределено) Экспорт
- ВалидироватьДжейСОН(СтрокаДжейСОН) Экспорт
- ПроверитьОбязательныеПоля(Данные, МассивПолей) Экспорт
- ВалидироватьТелефон(НомерТелефона) Экспорт
- ВалидироватьЭлектроннуюПочту(АдресЭлектроннойПочты) Экспорт

Обработчики HTTP-запросов (вызываются из HTTP-сервиса):
- ОбработатьПолучениеСпискаНоменклатуры(Запрос) Экспорт
- ОбработатьПолучениеДанныхНоменклатуры(Запрос) Экспорт
- ОбработатьПоискКлиента(Запрос) Экспорт
- ОбработатьСозданиеКлиента(Запрос) Экспорт
- ОбработатьПолучениеБалансаБонусов(Запрос) Экспорт
- ОбработатьСозданиеБронирования(Запрос) Экспорт
- ОбработатьПолучениеСтатусаБронирования(Запрос) Экспорт
- ОбработатьОтменуБронирования(Запрос) Экспорт
- ОбработатьПодтверждениеОплаты(Запрос) Экспорт
- ОбработатьПолучениеИнформацииОБилете(Запрос) Экспорт
- ОбработатьПолучениеБилетовКлиента(Запрос) Экспорт

Каждый обработчик:
1. Извлекает параметры из HTTP-запроса
2. Выполняет валидацию данных
3. Вызывает соответствующие методы бизнес-логики из других модулей
4. Формирует и возвращает HTTP-ответ
5. Записывает операцию в журнал
```

#### 4.2.2 УправлениеДаннымиСервер (серверный) - номенклатура и клиенты
```
Функции номенклатуры:
- ПолучитьСписокНоменклатурыДляПродажи(ПараметрыОтбора) Экспорт
- ПолучитьДанныеНоменклатуры(СсылкаНоменклатуры) Экспорт
- ПолучитьАктуальныеЦеныНоменклатуры(МассивНоменклатуры, ДатаАктуальности = Неопределено) Экспорт

Функции клиентов:
- НайтиКлиентаПоКонтактам(НомерТелефона = "", АдресЭлектроннойПочты = "") Экспорт
- СоздатьНовогоКлиента(ДанныеКлиента) Экспорт
- ПолучитьБалансБонусовКлиента(СсылкаКлиента) Экспорт
- ПроверитьВозможностьСписанияБонусов(СсылкаКлиента, СуммаКСписанию) Экспорт
```

#### 4.2.3 УправлениеБронированиемСервер (серверный) - бронирование, остатки, платежи
```
Функции бронирования:
- СоздатьБронирование(ДанныеБронирования) Экспорт
- ПолучитьСтатусБронирования(СсылкаБронирования) Экспорт
- ОтменитьБронирование(СсылкаБронирования, ПричинаОтмены = "") Экспорт

Функции контроля остатков:
- ПроверитьДоступностьНоменклатуры(СсылкаНоменклатуры, КоличествоКПроверке) Экспорт
- ЗарезервироватьПозиции(СсылкаБронирования, МассивПозиций) Экспорт
- ОсвободитьРезерв(СсылкаБронирования) Экспорт

Функции платежей:
- ПодтвердитьОплатуБронирования(СсылкаБронирования, ДанныеПлатежа) Экспорт
- СоздатьПродажуИзБронирования(СсылкаБронирования, ДанныеПлатежа) Экспорт
- ОбработатьБонусыПриОплате(СсылкаКлиента, СуммаПокупки, СуммаБонусовКСписанию) Экспорт
```

#### 4.2.4 СлужебныеОперацииСервер (серверный) - автоочистка и билеты
```
Функции автоочистки:
- ВыполнитьОчисткуИстекшихБронирований() Экспорт
- ПолучитьСписокИстекшихБронирований() Экспорт

Функции генерации билетов:
- СгенерироватьКьюАрКодДляБилета(СсылкаПродажаБилета) Экспорт
- СформироватьДанныеБилета(СсылкаПродажаБилета) Экспорт
- ПолучитьИнформациюОБилете(НомерБилета) Экспорт
- ПолучитьСписокБилетовКлиента(СсылкаКлиента, КоличествоЗаписей = 50, СмещениеЗаписей = 0) Экспорт
```

### 4.3 Регламентные задания

#### ОчисткаИстекшихБронирований
- **Расписание:** каждые 5 минут
- **Процедура:** СлужебныеОперацииСервер.ВыполнитьОчисткуИстекшихБронирований()
- **Использование:** Фоновые задания
- **Предопределенное:** Да
- **Наименование:** Очистка истекших бронирований через API

### 4.4 Использование существующих модулей

Для минимизации изменений в системе будут доработаны существующие модули:

1. **Справочники.Клиенты** - добавление методов для работы с API (если есть модуль объекта)
2. **Справочники.Номенклатура** - добавление методов получения данных для API
3. **Документы.ПродажаБилета** - добавление реквизита БронированиеБилетов и соответствующей логики
4. **Существующие модули бонусной программы** - интеграция с функциями УправлениеДаннымиСервер

Это позволит сократить количество нового кода и использовать уже проверенную логику.

### 4.5 Преимущества архитектуры для тестирования

**Разделение ответственности:**
- **HTTP-сервис** - только маршрутизация запросов
- **ОнлайнПродажиСервер** - обработка HTTP-запросов и координация
- **Специализированные модули** - бизнес-логика

**Возможности тестирования:**

1. **Модульное тестирование обработчиков:**
```bsl
// Можно тестировать обработчики напрямую без HTTP-сервиса
МакетЗапроса = Новый Структура("ПараметрыЗапроса", Новый Соответствие());
МакетЗапроса.ПараметрыЗапроса.Вставить("active_only", "true");

Результат = ОнлайнПродажиСервер.ОбработатьПолучениеСпискаНоменклатуры(МакетЗапроса);

УтверждениеТестирования.ПроверитьИстину(Результат.success);
```

2. **Изолированное тестирование бизнес-логики:**
```bsl
// Тестирование без HTTP-слоя
ПараметрыОтбора = Новый Структура("ТолькоАктивные", Истина);
СписокТоваров = УправлениеДаннымиСервер.ПолучитьСписокНоменклатурыДляПродажи(ПараметрыОтбора);

УтверждениеТестирования.ПроверитьБольше(СписокТоваров.Количество(), 0);
```

3. **Интеграционное тестирование HTTP-сервиса:**
- Тестирование полного цикла через HTTP-запросы
- Проверка корректности маршрутизации
- Валидация HTTP-статусов и заголовков

4. **Мокирование зависимостей:**
- Можно легко подменить вызовы других модулей для изолированного тестирования
- Тестирование обработки ошибок без реальных сбоев системы

## 5. ТЕСТОВЫЕ СЦЕНАРИИ

### 5.1 Функциональные тесты

#### Тест 1: Создание и оплата простой брони
```
Шаги:
1. Получить список номенклатуры: GET /api/v1/products
2. Найти клиента: GET /api/v1/customers/search?phone=+7900123456
3. Создать бронь: POST /api/v1/reservations
4. Подтвердить оплату: POST /api/v1/reservations/{id}/payment
5. Получить билет: GET /api/v1/tickets/{id}

Ожидаемый результат:
- Все запросы выполнены успешно
- Создан документ БронированиеБилетов со статусом "Оплачена"
- Создан документ ПродажаБилета
- Сгенерирован QR-код билета
```

#### Тест 2: Работа с бонусной программой
```
Предусловия: У клиента есть бонусные баллы

Шаги:
1. Получить баланс бонусов: GET /api/v1/customers/{id}/bonus
2. Создать бронь с использованием бонусов: POST /api/v1/reservations
3. Подтвердить оплату: POST /api/v1/reservations/{id}/payment
4. Проверить списание и начисление бонусов

Ожидаемый результат:
- Корректное списание бонусов при оплате
- Начисление новых бонусов за покупку
- Движения по регистру БонусныеБаллыКлиентов
```

#### Тест 3: Истечение времени брони
```
Шаги:
1. Создать бронь: POST /api/v1/reservations
2. Дождаться истечения времени брони (или изменить время программно)
3. Запустить регламентное задание очистки
4. Проверить статус брони: GET /api/v1/reservations/{id}
5. Попытаться оплатить истекшую бронь

Ожидаемый результат:
- Статус брони изменен на "Истекла"
- Освобожден резерв в регистре БронированиеПосещений
- Оплата истекшей брони отклонена с ошибкой 409
```

### 5.2 Нагрузочные тесты

#### Тест 4: Одновременные брони одного товара
```
Сценарий: 10 одновременных запросов на бронирование последнего доступного товара

Ожидаемый результат:
- Только одна бронь создана успешно
- Остальные 9 запросов получили ошибку 409 (недостаточно остатков)
- Нет конфликтов в базе данных
```

#### Тест 5: Массовая очистка истекших броней
```
Предусловия: 1000 истекших броней в системе

Ожидаемый результат:
- Все истекшие брони обработаны за разумное время (< 60 сек)
- Освобожден резерв по всем бронирням
- Нет блокировок базы данных
```

### 5.3 Тесты безопасности

#### Тест 6: Валидация входящих данных
```
Сценарии:
- Отправка некорректного JSON
- Отправка SQL-инъекций в полях
- Отправка XSS-скриптов
- Превышение лимитов размера данных

Ожидаемый результат:
- Все некорректные данные отклонены
- Возвращены соответствующие коды ошибок
- Системы не скомпрометированы
```

## 6. КРИТЕРИИ ПРИЕМКИ

### 6.1 Функциональные критерии
✅ Все API endpoints работают согласно спецификации  
✅ Система бронирования корректно резервирует и освобождает позиции  
✅ Интеграция с бонусной программой работает без ошибок  
✅ Автоматическая очистка истекших броней функционирует  
✅ Генерация QR-кодов и билетов работает корректно  

### 6.2 Производительные критерии  
✅ Время отклика API < 2 секунд для стандартных операций  
✅ Время создания брони < 5 секунд  
✅ Поддержка минимум 100 одновременных запросов  
✅ Регламентное задание обрабатывает до 1000 броней за минуту  

### 6.3 Критерии надежности
✅ Корректная обработка всех типов ошибок  
✅ Отсутствие потери данных при сбоях  
✅ Целостность данных при одновременных операциях  
✅ Полное логирование всех операций  

### 6.4 Критерии безопасности
✅ Валидация всех входящих данных  
✅ Защита от SQL-инъекций и XSS  
✅ Контроль доступа к API методам  
✅ Аудит всех операций с данными  

## 7. РИСКИ И МИТИГАЦИЯ

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Проблемы производительности при высокой нагрузке | Средняя | Высокое | Нагрузочное тестирование, оптимизация запросов, индексы БД |
| Конфликты при одновременном доступе к остаткам | Высокая | Среднее | Управляемые блокировки, транзакции, тестирование конкурентности |
| Ошибки интеграции с существующими модулями | Низкая | Высокое | Поэтапное тестирование, откат изменений, резервные копии |
| Сложность поддержки и развития | Средняя | Среднее | Детальная документация, code review, обучение команды |
| Проблемы с безопасностью API | Низкая | Высокое | Аудит безопасности, валидация данных, мониторинг |

## 8. ПЛАН РАЗВЕРТЫВАНИЯ

### 8.1 Подготовительный этап
1. **Резервное копирование** текущей конфигурации и базы данных
2. **Подготовка тестовой среды** идентичной продуктивной
3. **Настройка мониторинга** для отслеживания производительности

### 8.2 Этапы развертывания
1. **Разработка** → Развертывание на тестовой среде
2. **Тестирование** → Комплексное тестирование всех сценариев  
3. **Приемка** → Приемочное тестирование заказчиком
4. **Продуктив** → Развертывание на боевой среде в нерабочее время

### 8.3 План отката
В случае критических проблем:
1. Отключение API endpoints
2. Восстановление из резервной копии
3. Анализ проблем и доработка
4. Повторное развертывание

## 9. ПОДДЕРЖКА И СОПРОВОЖДЕНИЕ

### 9.1 Мониторинг
- Производительность API (время отклика)
- Количество ошибок и их типы  
- Статистика использования endpoints
- Мониторинг регламентных заданий

### 9.2 Обслуживание
- Регулярная очистка журналов API
- Анализ производительности запросов
- Обновление документации при изменениях
- Резервное копирование конфигурации

### 9.3 Развитие
Возможные направления развития:
- Добавление новых API методов
- Интеграция с мобильными приложениями
- Расширение функциональности бронирования
- Аналитика и отчетность по онлайн продажам

---

**Итого:** Проект займет 49 рабочих дней (7 недель) и создаст полнофункциональное решение для онлайн продажи билетов с интеграцией в существующую систему управления парком аттракционов.
