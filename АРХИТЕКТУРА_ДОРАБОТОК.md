# Архитектура доработок системы "Управление парком аттракционов"

## Обзор доработок

Данный документ описывает архитектуру доработок существующей системы управления парком аттракционов для реализации возможности онлайн продажи билетов через REST API.

## 1. Общая архитектура решения

### 1.1 Архитектурная схема

Система будет расширена следующими компонентами:
- REST API веб-сервис
- Система бронирования билетов
- Интеграция с внешними платежными системами
- Расширенная система контроля остатков

### 1.2 Диаграмма общей архитектуры

```mermaid
graph TB
    subgraph "Внешние системы"
        WEB[Веб-сайт парка]
        MOBILE[Мобильное приложение]
        PAY[Платежные системы]
    end
    
    subgraph "API Layer"
        API[REST API Сервис]
        AUTH[Аутентификация]
        VALID[Валидация данных]
    end
    
    subgraph "1С:Предприятие 8"
        subgraph "Новые модули"
            BOOKING[Управление бронированием]
            STOCK[Контроль остатков]
            ONLINE[API онлайн продаж]
        end
        
        subgraph "Существующие модули"
            SALES[Продажи]
            CLIENTS[Клиенты]
            BONUS[Бонусная программа]
            CATALOG[Номенклатура]
        end
        
        subgraph "База данных"
            DB[(База данных 1С)]
        end
    end
    
    WEB --> API
    MOBILE --> API
    API --> AUTH
    API --> VALID
    API --> BOOKING
    API --> ONLINE
    
    BOOKING --> SALES
    BOOKING --> STOCK
    ONLINE --> CLIENTS
    ONLINE --> BONUS
    ONLINE --> CATALOG
    
    PAY --> API
    
    SALES --> DB
    CLIENTS --> DB
    BONUS --> DB
    CATALOG --> DB
    BOOKING --> DB
```

## 2. Новые объекты метаданных

### 2.1 Структура новых объектов

#### Документ "БронированиеБилетов"
- **Назначение**: Фиксация онлайн бронирования билетов
- **Статусы**: Активная, Оплачена, Отменена, Истекла
- **Движения по регистрам**: БронированиеПосещений

#### Регистр накопления "БронированиеПосещений"
- **Назначение**: Учет забронированных посещений для контроля доступности
- **Измерения**: БронированиеБилетов, ВидАттракциона
- **Ресурсы**: КоличествоПосещений

#### Перечисление "СтатусыБронирования"
- Активная
- Оплачена
- Отменена
- Истекла

### 2.2 Диаграмма структуры данных

```mermaid
erDiagram
    БронированиеБилетов {
        string НомерДокумента
        datetime Дата
        ref Клиент
        enum СтатусБрони
        datetime ВремяИстечения
        number СуммаДокумента
        number СуммаБонусов
    }
    
    БронированиеБилетовПозиции {
        ref Номенклатура
        number Количество
        number Цена
        number Сумма
        date ДатаПосещения
        time ВремяПосещения
    }
    
    БронированиеПосещений {
        ref БронированиеБилетов
        ref ВидАттракциона
        number КоличествоПосещений
        datetime Период
    }
    
    ПродажаБилета {
        string НомерДокумента
        datetime Дата
        ref Клиент
        ref БронированиеБилетов
        number СуммаДокумента
        number СуммаБонусов
        string QRКод
    }
    
    БронированиеБилетов ||--o{ БронированиеБилетовПозиции : содержит
    БронированиеБилетов ||--o{ БронированиеПосещений : резервирует
    БронированиеБилетов ||--o| ПродажаБилета : создает
```

## 3. API Архитектура

### 3.1 REST API Endpoints

#### Основные группы endpoints:
- `/api/v1/products` - Управление номенклатурой
- `/api/v1/customers` - Управление клиентами
- `/api/v1/reservations` - Система бронирования
- `/api/v1/tickets` - Управление билетами

### 3.2 Диаграмма API архитектуры

```mermaid
graph LR
    subgraph "API Endpoints"
        PROD[/products]
        CUST[/customers]
        RES[/reservations]
        TICK[/tickets]
    end
    
    subgraph "API Controllers"
        PROD_CTRL[ProductsController]
        CUST_CTRL[CustomersController]
        RES_CTRL[ReservationsController]
        TICK_CTRL[TicketsController]
    end
    
    subgraph "Business Logic"
        PROD_BL[Управление номенклатурой]
        CUST_BL[Управление клиентами]
        RES_BL[Управление бронированием]
        TICK_BL[Управление билетами]
    end
    
    subgraph "Data Access"
        CATALOG_DA[Справочник.Номенклатура]
        CLIENT_DA[Справочник.Клиенты]
        BOOKING_DA[Документ.БронированиеБилетов]
        SALES_DA[Документ.ПродажаБилета]
    end
    
    PROD --> PROD_CTRL --> PROD_BL --> CATALOG_DA
    CUST --> CUST_CTRL --> CUST_BL --> CLIENT_DA
    RES --> RES_CTRL --> RES_BL --> BOOKING_DA
    TICK --> TICK_CTRL --> TICK_BL --> SALES_DA
```

## 4. Бизнес-процессы

### 4.1 Процесс онлайн бронирования

#### Диаграмма процесса бронирования

```mermaid
sequenceDiagram
    participant C as Клиент
    participant W as Веб-сайт
    participant API as REST API
    participant S as 1С Система
    participant P as Платежная система
    
    C->>W: Выбор билетов
    W->>API: POST /reservations
    API->>S: Проверка доступности
    S->>API: Подтверждение доступности
    API->>S: Создание брони
    S->>API: ID брони + время истечения
    API->>W: Данные брони
    W->>C: Форма оплаты
    
    C->>W: Подтверждение оплаты
    W->>P: Обработка платежа
    P->>W: Результат платежа
    W->>API: POST /reservations/{id}/payment
    API->>S: Создание продажи
    S->>API: Билет + QR-код
    API->>W: Данные билета
    W->>C: Билет
```

### 4.2 Процесс контроля остатков

#### Диаграмма контроля остатков

```mermaid
flowchart TD
    START([Запрос на бронирование])
    CHECK_TYPE{Тип номенклатуры}
    UNLIMITED[Неограниченная номенклатура]
    CHECK_STOCK[Проверка остатков]
    GET_ACTIVE[Получить активные посещения]
    GET_RESERVED[Получить забронированные]
    CALC[Рассчитать доступное количество]
    AVAILABLE{Доступно >= Запрашиваемое?}
    RESERVE[Резервирование]
    REJECT[Отклонить запрос]
    SUCCESS([Бронь создана])
    
    START --> CHECK_TYPE
    CHECK_TYPE -->|Без ограничений| UNLIMITED
    CHECK_TYPE -->|С ограничениями| CHECK_STOCK
    UNLIMITED --> RESERVE
    CHECK_STOCK --> GET_ACTIVE
    GET_ACTIVE --> GET_RESERVED
    GET_RESERVED --> CALC
    CALC --> AVAILABLE
    AVAILABLE -->|Да| RESERVE
    AVAILABLE -->|Нет| REJECT
    RESERVE --> SUCCESS
```

### 4.3 Процесс управления истекшими бронями

#### Диаграмма очистки истекших броней

```mermaid
flowchart LR
    TIMER[Регламентное задание<br/>каждые 5 минут]
    FIND[Найти истекшие брони]
    FOUND{Найдены истекшие?}
    PROCESS[Обработать бронь]
    RELEASE[Освободить резерв]
    UPDATE_STATUS[Статус = Истекла]
    LOG[Записать в журнал]
    NEXT{Есть еще?}
    END([Завершение])
    
    TIMER --> FIND
    FIND --> FOUND
    FOUND -->|Да| PROCESS
    FOUND -->|Нет| END
    PROCESS --> RELEASE
    RELEASE --> UPDATE_STATUS
    UPDATE_STATUS --> LOG
    LOG --> NEXT
    NEXT -->|Да| PROCESS
    NEXT -->|Нет| END
```

## 5. Интеграция с существующей системой

### 5.1 Точки интеграции

#### Диаграмма интеграции

```mermaid
graph TD
    subgraph "Новые компоненты"
        API_MOD[API модули]
        BOOKING_DOC[Документ БронированиеБилетов]
        BOOKING_REG[Регистр БронированиеПосещений]
    end
    
    subgraph "Существующие компоненты"
        SALES_DOC[Документ ПродажаБилета]
        CLIENTS_CAT[Справочник Клиенты]
        PRODUCTS_CAT[Справочник Номенклатура]
        BONUS_REG[Регистр БонусныеБаллыКлиентов]
        VISITS_REG[Регистр АктивныеПосещения]
        PRICES_REG[Регистр ЦеныНоменклатуры]
    end
    
    API_MOD --> BOOKING_DOC
    BOOKING_DOC --> BOOKING_REG
    BOOKING_DOC --> SALES_DOC
    
    API_MOD --> CLIENTS_CAT
    API_MOD --> PRODUCTS_CAT
    API_MOD --> BONUS_REG
    API_MOD --> PRICES_REG
    
    SALES_DOC --> VISITS_REG
    SALES_DOC --> BONUS_REG
```

### 5.2 Модификации существующих объектов

#### Документ "ПродажаБилета"
- **Новый реквизит**: БронированиеБилетов (связь с онлайн бронью)
- **Модификация проведения**: Автоматическое освобождение резерва при создании из брони

## 6. Производительность

### 6.1 Оптимизация производительности

```mermaid
graph LR
    subgraph "Оптимизация запросов"
        INDEX[Индексы БД]
        BATCH[Пакетная обработка]
        QUERY_OPT[Оптимизация запросов]
    end
    
    API --> INDEX
    API --> BATCH
    API --> QUERY_OPT
```

## 7. Этапы реализации

### 7.1 План разработки

```mermaid
gantt
    title План разработки онлайн продаж
    dateFormat YYYY-MM-DD
    section Этап 1: Инфраструктура
    Создание веб-сервиса           :2024-01-01, 7d
    Новые объекты метаданных       :2024-01-03, 5d
    Базовая валидация             :2024-01-08, 3d
    
    section Этап 2: Номенклатура и клиенты
    API номенклатуры              :2024-01-11, 4d
    API клиентов                  :2024-01-13, 3d
    Интеграция с бонусами         :2024-01-15, 2d
    
    section Этап 3: Бронирование
    Система бронирования          :2024-01-18, 7d
    Контроль остатков             :2024-01-22, 5d
    Автоочистка броней            :2024-01-25, 3d
    
    section Этап 4: Платежи
    API подтверждения оплаты      :2024-01-29, 4d
    Создание продаж               :2024-02-01, 3d
    Генерация QR-кодов            :2024-02-03, 2d
    
    section Этап 5: Тестирование
    Модульное тестирование        :2024-02-05, 4d
    Интеграционное тестирование   :2024-02-08, 3d
    Нагрузочное тестирование      :2024-02-10, 2d
```

### 7.2 Диаграмма зависимостей компонентов

```mermaid
graph TD
    INFRA[Базовая инфраструктура]
    META[Новые объекты метаданных]
    AUTH[Аутентификация]
    
    PRODUCTS[API номенклатуры]
    CLIENTS[API клиентов]
    BONUS[Интеграция с бонусами]
    
    BOOKING[Система бронирования]
    STOCK[Контроль остатков]
    CLEANUP[Автоочистка броней]
    
    PAYMENT[API платежей]
    SALES[Создание продаж]
    QR[Генерация QR-кодов]
    
    TESTING[Тестирование]
    
    INFRA --> META
    INFRA --> AUTH
    
    META --> PRODUCTS
    META --> CLIENTS
    CLIENTS --> BONUS
    
    PRODUCTS --> BOOKING
    CLIENTS --> BOOKING
    BONUS --> BOOKING
    BOOKING --> STOCK
    BOOKING --> CLEANUP
    
    BOOKING --> PAYMENT
    PAYMENT --> SALES
    SALES --> QR
    
    STOCK --> TESTING
    CLEANUP --> TESTING
    QR --> TESTING
```

## 8. Поддержка системы

### 8.1 Базовые требования к поддержке

- **Резервное копирование**: Регулярное резервное копирование базы данных 1С
- **Обновления**: Контролируемое обновление платформы 1С:Предприятие
- **Документация**: Ведение технической документации изменений
- **Тестирование**: Регулярное тестирование работоспособности API

## 9. Детализация компонентов системы

### 9.1 Архитектура общих модулей

```mermaid
graph TD
    subgraph "Модули API"
        API_MAIN[APIОнлайнПродаж<br/>Основной модуль API]
        API_VALID[ВалидацияДанныхAPI<br/>Валидация входящих данных]
        API_AUTH[АутентификацияAPI<br/>Проверка доступа]
        API_RESP[ФормированиеОтветовAPI<br/>Стандартизация ответов]
    end
    
    subgraph "Модули бизнес-логики"
        BOOKING_MGR[УправлениеБронированием<br/>Создание и управление бронями]
        STOCK_CTRL[КонтрольОстатковБилетов<br/>Проверка доступности]
        PAYMENT_PROC[ОбработкаПлатежей<br/>Обработка оплат]
        TICKET_GEN[ГенерацияБилетов<br/>Создание билетов и QR-кодов]
    end
    
    subgraph "Служебные модули"
        CLEANUP[АвтоочисткаБроней<br/>Регламентная очистка]
    end
    
    API_MAIN --> API_VALID
    API_MAIN --> API_AUTH
    API_MAIN --> API_RESP
    API_MAIN --> BOOKING_MGR
    API_MAIN --> STOCK_CTRL
    API_MAIN --> PAYMENT_PROC
    API_MAIN --> TICKET_GEN
```

### 9.2 Диаграмма состояний брони

```mermaid
stateDiagram-v2
    [*] --> Создание
    Создание --> Активная: Успешная проверка остатков
    Создание --> [*]: Ошибка создания
    
    Активная --> Оплачена: Подтверждение оплаты
    Активная --> Отменена: Отмена клиентом
    Активная --> Истекла: Истечение времени
    
    Оплачена --> [*]: Создан билет
    Отменена --> [*]: Освобожден резерв
    Истекла --> [*]: Автоочистка
    
    note right of Активная
        Резерв посещений
        Время жизни: 15 минут
    end note
    
    note right of Оплачена
        Создается документ
        ПродажаБилета
    end note
```

### 9.3 Обработка ошибок

Система обрабатывает основные типы ошибок:
- **400 Bad Request** - ошибки валидации входящих данных
- **404 Not Found** - запрашиваемый ресурс не найден  
- **409 Conflict** - бизнес-ошибки (недостаточно остатков, бронь истекла)
- **500 Internal Server Error** - системные ошибки

### 9.4 Диаграмма взаимодействия с бонусной программой

```mermaid
sequenceDiagram
    participant API as REST API
    participant BOOKING as Модуль бронирования
    participant BONUS as Бонусная программа
    participant CLIENT as Справочник клиентов
    participant REG as Регистр бонусов
    
    API->>BOOKING: Создать бронь с бонусами
    BOOKING->>CLIENT: Получить клиента
    CLIENT->>BOOKING: Данные клиента
    BOOKING->>BONUS: Получить баланс бонусов
    BONUS->>REG: Запрос остатков
    REG->>BONUS: Текущий баланс
    BONUS->>BOOKING: Доступные бонусы
    
    BOOKING->>BONUS: Проверить возможность списания
    BONUS->>BOOKING: Подтверждение
    BOOKING->>API: Бронь создана
    
    Note over API,REG: При подтверждении оплаты
    
    API->>BOOKING: Подтвердить оплату
    BOOKING->>BONUS: Списать бонусы
    BONUS->>REG: Создать движение (расход)
    BOOKING->>BONUS: Начислить новые бонусы
    BONUS->>REG: Создать движение (приход)
    BOOKING->>API: Оплата подтверждена
```

## 10. Техническая спецификация API

### 10.1 Структура JSON ответов

```mermaid
classDiagram
    class APIResponse {
        +boolean success
        +object data
        +object error
        +string message
        +number timestamp
        +string request_id
    }
    
    class ErrorResponse {
        +string code
        +string message
        +object details
        +array validation_errors
    }
    
    class ProductResponse {
        +string id
        +string code
        +string name
        +string description
        +enum product_type
        +number price
        +boolean active
        +array images
        +object restrictions
    }
    
    class ReservationResponse {
        +string reservation_id
        +datetime expires_at
        +number total_amount
        +number bonus_discount
        +number final_amount
        +array items
        +object payment_info
    }
    
    APIResponse --> ErrorResponse : contains
    APIResponse --> ProductResponse : contains
    APIResponse --> ReservationResponse : contains
```

### 10.2 Валидация данных

Система выполняет валидацию входящих данных на нескольких уровнях:

1. **Синтаксическая валидация** - проверка корректности JSON структуры
2. **Семантическая валидация** - проверка соответствия бизнес-правилам
3. **Бизнес-валидация** - проверка остатков, существования ресурсов

## 11. Стратегия развертывания

### 11.1 Схема развертывания

```mermaid
graph TB
    subgraph "Среда разработки"
        DEV_1C[1С:Предприятие 8 Dev]
        DEV_DB[(База данных Dev)]
        DEV_WEB[Веб-сервер Dev]
    end
    
    subgraph "Тестовая среда"
        TEST_1C[1С:Предприятие 8 Test]
        TEST_DB[(База данных Test)]
        TEST_WEB[Веб-сервер Test]
        TEST_LOAD[Генератор нагрузки]
    end
    
    subgraph "Продуктивная среда"
        PROD_1C[1С:Предприятие 8 Prod]
        PROD_DB[(База данных Prod)]
        PROD_WEB[Веб-сервер Prod]
        PROD_MONITOR[Мониторинг]
        PROD_BACKUP[Резервное копирование]
    end
    
    DEV_1C --> DEV_DB
    DEV_1C --> DEV_WEB
    
    TEST_1C --> TEST_DB
    TEST_1C --> TEST_WEB
    TEST_LOAD --> TEST_WEB
    
    PROD_1C --> PROD_DB
    PROD_1C --> PROD_WEB
    PROD_MONITOR --> PROD_1C
    PROD_BACKUP --> PROD_DB
    
    DEV_WEB -.->|Развертывание| TEST_WEB
    TEST_WEB -.->|Развертывание| PROD_WEB
```

### 11.2 Стратегия миграции данных

```mermaid
flowchart TD
    START([Начало миграции])
    BACKUP[Создать резервную копию]
    VALIDATE_BACKUP{Копия корректна?}
    DEPLOY_META[Развернуть новые метаданные]
    VALIDATE_META{Метаданные корректны?}
    MIGRATE_DATA[Миграция существующих данных]
    VALIDATE_DATA{Данные корректны?}
    TEST_API[Тестирование API]
    VALIDATE_API{API работает?}
    GO_LIVE[Запуск в продуктив]
    ROLLBACK[Откат изменений]
    SUCCESS([Миграция завершена])
    FAILURE([Миграция отменена])
    
    START --> BACKUP
    BACKUP --> VALIDATE_BACKUP
    VALIDATE_BACKUP -->|Да| DEPLOY_META
    VALIDATE_BACKUP -->|Нет| FAILURE
    
    DEPLOY_META --> VALIDATE_META
    VALIDATE_META -->|Да| MIGRATE_DATA
    VALIDATE_META -->|Нет| ROLLBACK
    
    MIGRATE_DATA --> VALIDATE_DATA
    VALIDATE_DATA -->|Да| TEST_API
    VALIDATE_DATA -->|Нет| ROLLBACK
    
    TEST_API --> VALIDATE_API
    VALIDATE_API -->|Да| GO_LIVE
    VALIDATE_API -->|Нет| ROLLBACK
    
    GO_LIVE --> SUCCESS
    ROLLBACK --> FAILURE
```

## 12. Заключение

Предложенная архитектура доработок обеспечивает:

1. **Интеграцию с существующей системой** без нарушения текущих бизнес-процессов
2. **Масштабируемость** для обработки большого количества онлайн заказов
3. **Надежность** через систему бронирования с автоматической очисткой
4. **Производительность** через оптимизацию запросов к базе данных
5. **Отказоустойчивость** через обработку ошибок и стратегию развертывания

### 12.1 Ключевые преимущества архитектуры

- **Модульность**: Четкое разделение ответственности между компонентами
- **Расширяемость**: Возможность добавления новых функций без изменения базовой архитектуры
- **Совместимость**: Полная совместимость с существующими бизнес-процессами
- **Производительность**: Оптимизированные алгоритмы работы с данными

### 12.2 Риски и их митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Проблемы производительности | Средняя | Высокое | Нагрузочное тестирование, оптимизация запросов |
| Ошибки интеграции | Низкая | Высокое | Комплексное тестирование, поэтапное развертывание |

| Сложность поддержки | Средняя | Среднее | Подробная документация, обучение команды |

Реализация займет приблизительно 7 недель и потребует тесной координации с командой разработки внешнего веб-сайта для обеспечения корректной интеграции.
